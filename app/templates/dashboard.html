{% extends 'base.html' %}

{% block content %}
<div class="container my-5">
    <div class="row mb-4 align-items-center">
        <div class="col-8">
            <h2 class="display-6 fw-bold text-primary">ğŸ‘‹ æ¬¢è¿, {{ session.get('nickname', 'ç”¨æˆ·') }}</h2>
            <p class="text-muted small">ä»Šæ—¥: {{ today }} | æ¯æ—¥æŒ‰æ—¶æœè¯ï¼Œå¥åº·å¸¸ä¼´ã€‚</p>
        </div>
        <div class="col-4 text-end">
            <a href="{{ url_for('main.medicine_list') }}" class="btn btn-outline-primary btn-sm">+ æ·»åŠ è¯å“</a>
        </div>
    </div>

    <!-- Medicine List -->
    {% if tasks %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for task in tasks %}
        <div class="col">
            <div class="card h-100 shadow-sm border-0 {% if task.status == 'completed' %}bg-light opacity-75{% endif %}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title fw-bold text-dark">{{ task.medicine_name }}</h5>
                        {% if task.status == 'completed' %}
                        <span class="badge bg-success rounded-pill">å®Œæˆ</span>
                        {% else %}
                        <span class="badge bg-warning text-dark rounded-pill">å¾…æœ</span>
                        {% endif %}
                    </div>
                    
                    <ul class="list-unstyled small text-muted mb-3">
                        <li class="mb-1"><i class="bi bi-capsule"></i> å‰‚é‡: {{ task.dose }}</li>
                        <li class="mb-1"><i class="bi bi-clock"></i> æ—¶é—´: {{ task.times | join(', ') }}</li>
                        <li><i class="bi bi-progress"></i> è¿›åº¦: {{ task.taken_count }} / {{ task.total_count }} æ¬¡</li>
                    </ul>

                    {% if task.status != 'completed' %}
                    <button class="btn btn-primary w-100 btn-sm mark-taken" data-id="{{ task.schedule_id }}">
                        æ ‡è®°ä»Šæ—¥å·²æœç”¨
                    </button>
                    {% else %}
                    <button class="btn btn-secondary w-100 btn-sm" disabled>ä»Šæ—¥å·²å®Œæˆ</button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <div class="display-1 text-muted opacity-25 mb-3">ğŸ“­</div>
        <p class="lead text-muted">ä»Šæ—¥æ²¡æœ‰éœ€è¦æœç”¨çš„è¯å“ã€‚</p>
        <a href="{{ url_for('main.medicine_list') }}" class="btn btn-primary mt-3">å»æ·»åŠ ä¸€äº›è¯å“?</a>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
document.querySelectorAll('.mark-taken').forEach(btn => {
    btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        try {
            const res = await fetch(`/schedule/mark_taken/${id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            if (res.ok) {
                location.reload();
            } else {
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        } catch (e) {
            console.error(e);
            alert('ç½‘ç»œé”™è¯¯');
        }
    });
});
</script>
{% endblock %}
