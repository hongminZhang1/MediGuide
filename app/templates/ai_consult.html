{% extends 'base.html' %}

{% block content %}
<style>
    body {
        background: #f5f7fa;
    }
    
    .chat-container {
        max-width: 1000px;
        margin: 20px auto;
        height: calc(100vh - 140px);
        min-height: 700px;
        display: flex;
        flex-direction: column;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    .chat-header {
        background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 60%, #3b82f6 100%);
        color: white;
        padding: 20px 28px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .chat-header h2 {
        margin: 0;
        font-size: 1.3rem;
        font-weight: 700;
    }
    
    .chat-header p {
        margin: 6px 0 0 0;
        font-size: 0.85rem;
        opacity: 0.9;
    }
    
    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
    }
    
    .message {
        display: flex;
        margin-bottom: 12px;
        animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .message.user {
        justify-content: flex-end;
    }
    
    .message.assistant {
        justify-content: flex-start;
    }
    
    .message-bubble {
        max-width: 75%;
        padding: 14px 18px;
        border-radius: 16px;
        position: relative;
        word-wrap: break-word;
        line-height: 1.6;
    }
    
    .message.user .message-bubble {
        background: linear-gradient(135deg, #1d4ed8 0%, #3b82f6 100%);
        color: white;
        border-bottom-right-radius: 4px;
        box-shadow: 0 4px 14px rgba(37, 99, 235, 0.3);
    }
    
    .message.assistant .message-bubble {
        background: white;
        color: #2d3748;
        border: 1px solid #e2e8f0;
        border-bottom-left-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    /* æ€è€ƒè¿‡ç¨‹æ ·å¼ */
    .reasoning-section {
        margin-bottom: 12px;
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid #bfdbfe;
    }
    
    .reasoning-header {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        padding: 8px 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.8rem;
        font-weight: 600;
        color: #1e3a8a;
        transition: all 0.3s ease;
    }
    
    .reasoning-header:hover {
        background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%);
    }
    
    .reasoning-header .icon {
        margin-right: 6px;
    }
    
    .reasoning-header .toggle {
        font-size: 0.7rem;
        transition: transform 0.3s ease;
    }
    
    .reasoning-header .toggle.collapsed {
        transform: rotate(-90deg);
    }
    
    .reasoning-content {
        padding: 12px;
        background: #f8fafc;
        font-size: 0.8rem;
        line-height: 1.5;
        color: #475569;
        max-height: 250px;
        overflow-y: auto;
    }
    
    .reasoning-content.collapsed {
        display: none;
    }
    
    /* Markdown æ ·å¼ */
    .message-bubble ul, .message-bubble ol {
        padding-left: 18px;
        margin: 6px 0;
    }
    
    .message-bubble li {
        margin: 3px 0;
    }
    
    .message-bubble code {
        background: rgba(0,0,0,0.05);
        padding: 2px 5px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }
    
    /* è¾“å…¥åŒºåŸŸ */
    .input-container {
        padding: 16px 20px;
        background: white;
        border-top: 1px solid #e2e8f0;
    }
    
    .input-wrapper {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .input-group-custom {
        flex: 1;
    }
    
    .model-selector {
        display: flex;
        align-items: center;
        flex-shrink: 0;
    }
    
    .model-selector label {
        display: none;
    }
    
    .model-selector select {
        height: 40px;
        padding: 0 10px;
        border: 1.5px solid #cbd5e1;
        border-radius: 8px;
        font-size: 0.82rem;
        color: #475569;
        background: white;
        cursor: pointer;
        transition: border-color 0.3s ease;
        min-width: 110px;
    }
    
    .model-selector select:focus {
        outline: none;
        border-color: #3b82f6;
    }
    
    #user-input {
        width: 100%;
        height: 40px;
        padding: 0 14px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 0.9rem;
        resize: none;
        transition: border-color 0.3s ease;
        font-family: inherit;
        line-height: 40px;
        overflow: hidden;
    }
    
    #user-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }
    
    #user-input:disabled {
        background: #f1f5f9;
        cursor: not-allowed;
    }
    
    #send-btn {
        width: 42px;
        height: 42px;
        padding: 0;
        background: linear-gradient(135deg, #1d4ed8 0%, #3b82f6 100%);
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 1.05rem;
        cursor: pointer;
        transition: all 0.25s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.32);
    }
    
    #send-btn:hover:not(:disabled) {
        transform: translateY(-2px) scale(1.08);
        box-shadow: 0 8px 20px rgba(37, 99, 235, 0.48);
    }
    
    #send-btn:active:not(:disabled) {
        transform: scale(0.95);
    }
    
    #send-btn:disabled {
        opacity: 0.45;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    /* åŠ è½½åŠ¨ç”» */
    .typing-indicator {
        display: inline-flex;
        gap: 4px;
        padding: 8px 0;
    }
    
    .typing-indicator span {
        width: 8px;
        height: 8px;
        background: #94a3b8;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
    }
    
    .typing-indicator span:nth-child(1) {
        animation-delay: -0.32s;
    }
    
    .typing-indicator span:nth-child(2) {
        animation-delay: -0.16s;
    }
    
    @keyframes bounce {
        0%, 80%, 100% {
            transform: scale(0);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    /* æ»šåŠ¨æ¡æ ·å¼ */
    .messages-container::-webkit-scrollbar,
    .reasoning-content::-webkit-scrollbar {
        width: 6px;
    }
    
    .messages-container::-webkit-scrollbar-track,
    .reasoning-content::-webkit-scrollbar-track {
        background: #f1f5f9;
    }
    
    .messages-container::-webkit-scrollbar-thumb,
    .reasoning-content::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }
    
    .messages-container::-webkit-scrollbar-thumb:hover,
    .reasoning-content::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
    
    /* å…è´£å£°æ˜ */
    .disclaimer {
        text-align: center;
        font-size: 0.75rem;
        color: #94a3b8;
        margin-top: 6px;
    }
    
    /* æ¬¢è¿æ¶ˆæ¯æ ·å¼ */
    .welcome-message {
        text-align: center;
        padding: 30px 20px 20px;
        color: #64748b;
    }
    
    .welcome-message h3 {
        color: #475569;
        margin-bottom: 12px;
        font-size: 1.15rem;
        font-weight: 600;
    }
    
    .welcome-message p {
        margin: 6px 0;
        font-size: 0.9rem;
        line-height: 1.6;
    }
    
    .welcome-message .features-list {
        text-align: left;
        display: inline-block;
        margin: 8px 0;
    }

    /* å¸¸è§é—®é¢˜å¿«æ·æŒ‰é’® */
    .quick-questions {
        margin-top: 20px;
        padding: 0 4px;
    }

    .quick-questions-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: #94a3b8;
        letter-spacing: 0.03em;
        margin-bottom: 10px;
        text-transform: uppercase;
    }

    .quick-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
    }

    .quick-chip {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 7px 14px;
        background: white;
        border: 1.5px solid #bfdbfe;
        border-radius: 20px;
        font-size: 0.82rem;
        color: #1d4ed8;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        box-shadow: 0 2px 6px rgba(37,99,235,0.08);
    }

    .quick-chip:hover {
        background: linear-gradient(135deg, #1d4ed8 0%, #3b82f6 100%);
        color: white;
        border-color: transparent;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(37,99,235,0.28);
    }
</style>

<div class="container-fluid px-2">
    <div class="chat-container">
        <!-- èŠå¤©å¤´éƒ¨ -->
        <div class="chat-header">
            <h2>ğŸ¤– AI æ™ºèƒ½è¾…åŠ©é—®è¯Š</h2>
            <p>åŸºäº DeepSeek å¤§æ¨¡å‹ Â· æä¾›å¥åº·é—®é¢˜åˆæ­¥åˆ†æä¸å»ºè®® Â· ä¸æ›¿ä»£ä¸“ä¸šåŒ»ç–—è¯Šæ–­</p>
        </div>
        
        <!-- æ¶ˆæ¯åˆ—è¡¨ -->
        <div class="messages-container" id="messages-container">
            <div class="welcome-message">
                <h3>ğŸ‘‹ æ‚¨å¥½ï¼Œæˆ‘æ˜¯å°æ™´ - AI æ™ºèƒ½è¾…åŠ©é—®è¯ŠåŠ©æ‰‹</h3>
                <p style="font-size: 0.88rem; color: #64748b; margin-top: 10px;">
                    æˆ‘æ˜¯åŸºäºå¤§è¯­è¨€æ¨¡å‹çš„æ™ºèƒ½é—®è¯Šç³»ç»Ÿï¼Œå¯ä»¥å¸®æ‚¨ï¼š
                </p>
                <div class="features-list" style="font-size: 0.88rem; color: #64748b; margin-top: 8px;">
                    â€¢ åˆæ­¥åˆ†æç—‡çŠ¶å¯èƒ½çš„åŸå› <br>
                    â€¢ æä¾›å°±åŒ»å’Œæ—¥å¸¸æŠ¤ç†å»ºè®®<br>
                    â€¢ è§£ç­”ç”¨è¯ç›¸å…³é—®é¢˜
                </div>
                <p style="font-size: 0.82rem; color: #94a3b8; margin-top: 12px; font-style: italic;">
                    è¯·è¯¦ç»†æè¿°æ‚¨çš„ç—‡çŠ¶ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹å¸¸è§é—®é¢˜å¿«é€Ÿå¼€å§‹
                </p>

                <!-- å¸¸è§é—®é¢˜å¿«æ·æŒ‰é’® -->
                <div class="quick-questions">
                    <div class="quick-questions-title">ğŸ’¡ å¸¸è§é—®é¢˜</div>
                    <div class="quick-chips">
                        <button class="quick-chip" onclick="askQuestion('æˆ‘æœ€è¿‘å¤´ç—›ã€å¤´æ™•ï¼Œæœ‰æ—¶ä¼´æœ‰æ¶å¿ƒï¼Œå¯èƒ½æ˜¯ä»€ä¹ˆåŸå› ï¼Ÿ')">
                            ğŸ¤• å¤´ç—›å¤´æ™•
                        </button>
                        <button class="quick-chip" onclick="askQuestion('æˆ‘å‘çƒ§38.5åº¦ï¼Œä¼´æœ‰æµé¼»æ¶•ã€å’³å—½ï¼Œåº”è¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ')">
                            ğŸŒ¡ï¸ å‘çƒ§æ„Ÿå†’
                        </button>
                        <button class="quick-chip" onclick="askQuestion('æˆ‘æœ€è¿‘èƒƒéƒ¨ä¸é€‚ï¼Œé¥­åèƒ€æ°”ã€åé…¸ï¼Œæœ‰æ—¶éšéšä½œç—›ï¼Œæ€ä¹ˆåŠï¼Ÿ')">
                            ğŸ«ƒ èƒƒéƒ¨ä¸é€‚
                        </button>
                        <button class="quick-chip" onclick="askQuestion('æˆ‘çš„è¡€å‹åé«˜ï¼Œå¹³æ—¶åº”è¯¥æ³¨æ„å“ªäº›äº‹é¡¹ï¼Ÿæœ‰å“ªäº›å¸¸ç”¨è¯ç‰©ï¼Ÿ')">
                            â¤ï¸ é«˜è¡€å‹
                        </button>
                        <button class="quick-chip" onclick="askQuestion('æˆ‘ç¡çœ è´¨é‡å¾ˆå·®ï¼Œç»å¸¸å¤±çœ ï¼Œè¯¥å¦‚ä½•æ”¹å–„ï¼Ÿ')">
                            ğŸ˜´ å¤±çœ å›°æ‰°
                        </button>
                        <button class="quick-chip" onclick="askQuestion('æˆ‘è¡€ç³–åé«˜ï¼Œé¥®é£Ÿä¸Šéœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿæ—¥å¸¸å¦‚ä½•æ§ç³–ï¼Ÿ')">
                            ğŸ¬ è¡€ç³–ç®¡ç†
                        </button>
                        <button class="quick-chip" onclick="askQuestion('æˆ‘æœ€è¿‘æŒç»­å’³å—½è¶…è¿‡ä¸€å‘¨ï¼Œæœ‰æ—¶æœ‰ç—°ï¼Œè¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ')">
                            ğŸ˜®â€ğŸ’¨ æŒç»­å’³å—½
                        </button>
                        <button class="quick-chip" onclick="askQuestion('æˆ‘çš„å…³èŠ‚ç–¼ç—›ï¼Œå°¤å…¶æ˜¯è†ç›–ï¼Œä¸Šä¸‹æ¥¼æ¢¯åŠ é‡ï¼Œæ˜¯ä»€ä¹ˆé—®é¢˜ï¼Ÿ')">
                            ğŸ¦µ å…³èŠ‚ç–¼ç—›
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="input-container">
            <div class="input-wrapper">
                <div class="input-group-custom">
                    <textarea 
                        id="user-input" 
                        rows="1" 
                        placeholder="æè¿°æ‚¨çš„ç—‡çŠ¶..." 
                    ></textarea>
                </div>
                <div class="model-selector">
                    <label for="model-select">æ¨¡å‹:</label>
                    <select id="model-select">
                        <option value="deepseek-chat">V3 å¿«é€Ÿ</option>
                        <option value="deepseek-reasoner">R1 æ·±åº¦æ€è€ƒ</option>
                    </select>
                </div>
                <button id="send-btn" title="å‘é€">
                    <i class="bi bi-send-fill" style="transform: translateX(1px);"></i>
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const messagesContainer = document.getElementById('messages-container');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const modelSelect = document.getElementById('model-select');
    
    let messages = [];
    let isLoading = false;

    // ç‚¹å‡»å¸¸è§é—®é¢˜å¿«æ·æŒ‰é’®
    function askQuestion(text) {
        if (isLoading) return;
        userInput.value = text;
        userInput.focus();
        sendMessage();
    }
    
    // Markdown ç®€å•è§£æ
    function parseMarkdown(text) {
        return text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/\n/g, '<br>');
    }
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    function addUserMessage(content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user';
        messageDiv.innerHTML = `
            <div class="message-bubble">
                ${parseMarkdown(content)}
            </div>
        `;
        
        // ç§»é™¤æ¬¢è¿æ¶ˆæ¯
        const welcomeMsg = messagesContainer.querySelector('.welcome-message');
        if (welcomeMsg) {
            welcomeMsg.remove();
        }
        
        messagesContainer.appendChild(messageDiv);
        scrollToBottom();
    }
    
    // æ·»åŠ  AI æ¶ˆæ¯
    function addAssistantMessage() {
        const messageId = `msg-${Date.now()}`;
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message assistant';
        messageDiv.id = messageId;
        messageDiv.innerHTML = `
            <div class="message-bubble">
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        scrollToBottom();
        
        return messageId;
    }
    
    // æ›´æ–° AI æ¶ˆæ¯å†…å®¹
    function updateAssistantMessage(messageId, content, reasoningContent, isThinking) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;
        
        const bubble = messageDiv.querySelector('.message-bubble');
        let html = '';
        
        // æ€è€ƒè¿‡ç¨‹éƒ¨åˆ†ï¼ˆä»… R1 æ¨¡å‹ï¼‰
        if (reasoningContent) {
            const isCollapsed = !isThinking;
            html += `
                <div class="reasoning-section">
                    <div class="reasoning-header" onclick="toggleReasoning('${messageId}')">
                        <div>
                            <span class="icon">${isThinking ? 'ğŸ¤”' : 'ğŸ’¡'}</span>
                            <span>${isThinking ? 'æ­£åœ¨æ€è€ƒ...' : 'æ€è€ƒè¿‡ç¨‹'}</span>
                        </div>
                        <span class="toggle ${isCollapsed ? 'collapsed' : ''}">â–¼</span>
                    </div>
                    <div class="reasoning-content ${isCollapsed ? 'collapsed' : ''}">
                        ${parseMarkdown(reasoningContent)}
                    </div>
                </div>
            `;
        }
        
        // å›å¤å†…å®¹
        if (content) {
            html += parseMarkdown(content);
        } else if (!reasoningContent) {
            html = `
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
        }
        
        bubble.innerHTML = html;
        scrollToBottom();
    }
    
    // åˆ‡æ¢æ€è€ƒè¿‡ç¨‹æ˜¾ç¤º
    window.toggleReasoning = function(messageId) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;
        
        const content = messageDiv.querySelector('.reasoning-content');
        const toggle = messageDiv.querySelector('.toggle');
        
        if (content) {
            content.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }
    };
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // æµå¼è¯»å–å“åº”
    async function* streamReader(response) {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        try {
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value, { stream: true });
                buffer += chunk;
                
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';
                
                for (const line of lines) {
                    const trimmed = line.trim();
                    if (!trimmed || trimmed === 'data: [DONE]') continue;
                    if (trimmed.startsWith('data: ')) {
                        try {
                            const json = JSON.parse(trimmed.slice(6));
                            yield json;
                        } catch (e) {
                            console.warn('JSON Parse error:', e);
                        }
                    }
                }
            }
        } finally {
            reader.releaseLock();
        }
    }
    
    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text || isLoading) return;
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        messages.push({ role: 'user', content: text });
        addUserMessage(text);
        
        userInput.value = '';
        isLoading = true;
        sendBtn.disabled = true;
        userInput.disabled = true;
        
        // åˆ›å»º AI æ¶ˆæ¯
        const messageId = addAssistantMessage();
        
        try {
            const model = modelSelect.value;
            
            // è°ƒç”¨æµå¼ API
            const response = await fetch('/api/chat/deepseek', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    messages: messages,
                    model: model
                })
            });
            
            if (!response.ok) {
                throw new Error(`API Error: ${response.statusText}`);
            }
            
            let fullContent = '';
            let fullReasoning = '';
            
            // è¯»å–æµå¼å“åº”
            for await (const chunk of streamReader(response)) {
                if (chunk.error) {
                    throw new Error(chunk.error);
                }
                
                const delta = chunk.choices?.[0]?.delta;
                if (delta) {
                    // æ€è€ƒè¿‡ç¨‹
                    if (delta.reasoning_content) {
                        fullReasoning += delta.reasoning_content;
                    }
                    // å›å¤å†…å®¹
                    if (delta.content) {
                        fullContent += delta.content;
                    }
                    
                    // å®æ—¶æ›´æ–°æ˜¾ç¤º
                    updateAssistantMessage(messageId, fullContent, fullReasoning, true);
                }
            }
            
            // å®Œæˆåæ›´æ–°çŠ¶æ€
            updateAssistantMessage(messageId, fullContent, fullReasoning, false);
            
            // ä¿å­˜ AI æ¶ˆæ¯
            messages.push({ role: 'assistant', content: fullContent });
            
        } catch (error) {
            console.error('Chat error:', error);
            
            // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
            let errorMessage = 'æŠ±æ­‰ï¼Œå‡ºç°äº†é”™è¯¯ã€‚';
            if (error.message) {
                errorMessage += `\n\né”™è¯¯è¯¦æƒ…ï¼š${error.message}`;
            }
            
            // æ·»åŠ è°ƒè¯•å»ºè®®
            errorMessage += '\n\nè¯·æ£€æŸ¥ï¼š\n';
            errorMessage += '1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n';
            errorMessage += '2. API Key æ˜¯å¦æ­£ç¡®é…ç½®\n';
            errorMessage += '3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯';
            
            updateAssistantMessage(
                messageId, 
                errorMessage, 
                '', 
                false
            );
        } finally {
            isLoading = false;
            sendBtn.disabled = false;
            userInput.disabled = false;
            userInput.focus();
        }
    }
    
    // äº‹ä»¶ç›‘å¬
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
    userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
</script>
{% endblock %}
